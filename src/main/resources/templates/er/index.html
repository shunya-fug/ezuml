<!DOCTYPE html>
<html
  lang="ja"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{common/layout}"
>
  <head>
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />
    <style>
      .material-symbols-outlined {
        font-variation-settings: "FILL" 0, "wght" 0, "GRAD" 0, "opsz" 24;
      }

      .accordion-button::after {
        margin-left: 20px;
      }
    </style>
  </head>

  <!--/* コンテンツ */-->
  <div layout:fragment="contents">
    <main>
      <div class="container-lg">
        <div class="vstack gap-3 font-monospace">
          <div v-for="(table, tableIndex) in tableList" class="card">
            <div class="card-header">
              <!--/* テーブル名 */-->
              <div class="row m-sm-3">
                <div class="col input-group">
                  <span class="input-group-text user-select-none">TableName</span>
                  <input
                      type="text"
                      class="form-control"
                      :class="{ 'is-invalid': isError(`tableList[${tableIndex}].name`) }"
                      aria-label="TableName"
                      v-model="table.name"
                  />
                </div>
                <div class="col-1 d-flex justify-content-center">
                  <button
                      type="button"
                      class="btn"
                      :class="tableList?.length == 1 ? 'btn-outline-secondary' : 'btn-outline-danger'"
                      @click="deleteTable(tableIndex)"
                      :disabled="tableList?.length == 1"
                  >
                    <span class="align-middle material-symbols-outlined">delete_forever</span>
                  </button>
                </div>
                <div
                    class="col-11 text-end"
                    v-if="isError(`tableList[${tableIndex}].name`)"
                    v-for="message in getErrorMessageList(`tableList[${tableIndex}].name`)"
                >
                  <span class="text-danger">{{ message }}</span>
                </div>
              </div>
            </div>
            <div class="card-body vstack m-sm-3 gap-3">
              <!--/* カラム定義 */-->
              <div :id="`columnDefinitionAccordion-${tableIndex}`" class="accordion">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button
                      type="button"
                      class="accordion-button"
                      data-bs-toggle="collapse"
                      :data-bs-target="`#columnDefinition-${tableIndex}`"
                      aria-expanded="true"
                      :aria-controls="`columnDefinition-${tableIndex}`"
                    >
                      <span class="user-select-none">Columns</span>
                      <span class="ms-auto">{{ table.columnList?.length }}</span>
                    </button>
                  </h2>
                  <div
                    :id="`columnDefinition-${tableIndex}`"
                    class="accordion-collapse collapse show"
                    :data-bs-parent="`#columnDefinitionAccordion-${tableIndex}`"
                  >
                    <div class="accordion-body m-sm-3">
                      <div class="vstack gap-2" :class="`columnSwapyContainer-${tableIndex}`">
                        <div class="row user-select-none">
                          <div class="col-1 text-end">#</div>
                          <div class="col">Name</div>
                        </div>
                        <div
                          class="row"
                          v-for="(column, columnIndex) in table.columnList"
                          :data-swapy-slot="`columnSwapySlot-${tableIndex}-${columnIndex}`"
                        >
                          <div class="row" :data-swapy-item="`columnSwapyItem-${tableIndex}-${columnIndex}`">
                            <div class="col-1 d-flex align-items-center">
                              <div
                                class="flex-fill align-middle material-symbols-outlined text-center"
                                data-swapy-handle
                              >
                                drag_indicator
                              </div>
                              <div class="flex-fill text-end">{{ columnIndex + 1 }}</div>
                            </div>
                            <div class="col hstack gap-3">
                              <input
                                type="text"
                                :name="`column-${tableIndex}-${columnIndex}`"
                                class="form-control"
                                :class="{ 'is-invalid': isError(`tableList[${tableIndex}].columnList[${columnIndex}].name`) }"
                                v-model="column.name"
                              />
                            </div>
                            <div class="col-1 d-flex justify-content-center">
                              <button
                                type="button"
                                class="btn"
                                :class="table.columnList?.length == 1 ? 'btn-outline-secondary' : 'btn-outline-danger'"
                                @click="deleteColumn(tableIndex, columnIndex)"
                                :disabled="table.columnList?.length == 1"
                              >
                                <span class="align-middle material-symbols-outlined">delete_forever</span>
                              </button>
                            </div>
                            <div
                                class="offset-1 col-10 text-end"
                                v-if="isError(`tableList[${tableIndex}].columnList[${columnIndex}].name`)"
                                v-for="message in getErrorMessageList(`tableList[${tableIndex}].columnList[${columnIndex}].name`)"
                            >
                              <span class="text-danger">{{ message }}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                      <div class="pt-3 d-flex justify-content-center">
                        <button
                          class="btn btn-outline-secondary"
                          @click="addColumn(tableIndex)"
                        >
                          <span class="align-middle material-symbols-outlined">add</span>
                          Add Column
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--/* リレーション定義 */-->
              <div :id="`relationDefinitionAccordion-${tableIndex}`" class="accordion">
                <div class="accordion-item">
                  <h2 class="accordion-header">
                    <button
                      type="button"
                      class="accordion-button collapsed"
                      data-bs-toggle="collapse"
                      :data-bs-target="`#relationDefinition-${tableIndex}`"
                      aria-expanded="false"
                      :aria-controls="`relationDefinition-${tableIndex}`"
                    >
                      <span class="user-select-none">Relation</span>
                      <span class="ms-auto">{{ table.relationList?.length }}</span>
                    </button>
                  </h2>
                  <div
                    :id="`relationDefinition-${tableIndex}`"
                    class="accordion-collapse collapse"
                    :data-bs-parent="`relationDefinitionAccordion-${tableIndex}`"
                  >
                    <div class="accordion-body m-sm-3">
                      <div class="vstack gap-1">
                        <div class="row" v-for="(relation, relationIndex) in table.relationList">
                          <div class="col">
                            <input type="text" class="form-control" :value="relation.from = table.name" disabled />
                          </div>
                          <div class="col-1">
                            <select class="form-select" v-model="relation.fromType">
                              <option
                                th:each="relationEdgeType, stat : ${relationEdgeTypeEnum}"
                                th:value="${relationEdgeType.name}"
                                th:text="${relationEdgeType.text}"
                              ></option>
                            </select>
                          </div>
                          <div class="col-3">
                            <div class="input-group">
                              <button
                                type="button"
                                class="btn btn-outline-secondary"
                                @click="relation.lineLength--"
                                :disabled="relation.lineLength <= 1"
                              >
                                <span class="align-middle material-symbols-outlined">remove</span>
                              </button>
                              <select class="form-select" v-model="relation.lineType">
                                <option
                                  th:each="relationLineType : ${relationLineTypeEnum}"
                                  th:value="${relationLineType.name}"
                                  th::text="|'${relationLineType.sign}'.repeat(relation.lineLength)|"
                                ></option>
                              </select>
                              <button
                                type="button"
                                class="btn btn-outline-secondary"
                                @click="relation.lineLength++"
                                :disabled="relation.lineLength >= 5"
                              >
                                <span class="align-middle material-symbols-outlined">add</span>
                              </button>
                            </div>
                          </div>
                          <div class="col-1">
                            <select class="form-select" v-model="relation.toType">
                              <option
                                th:each="relationEdgeType : ${relationEdgeTypeEnum}"
                                th:value="${relationEdgeType.name}"
                                th:text="${relationEdgeType.text}"
                              ></option>
                            </select>
                          </div>
                          <div class="col">
                            <select class="form-select" v-model="relation.to">
                              <option v-for="option in relationOptionList(tableIndex)" :value="option">
                                {{ option }}
                              </option>
                            </select>
                          </div>
                          <div class="col-1 d-flex justify-content-center">
                            <button
                              type="button"
                              class="btn btn-outline-danger"
                              @click="deleteRelation(tableIndex, relationIndex)"
                            >
                              <span class="align-middle material-symbols-outlined">delete_forever</span>
                            </button>
                          </div>
                        </div>
                      </div>
                      <div class="d-flex justify-content-center" :class="{ 'pt-3': table.relationList?.length > 0 }">
                        <button
                          class="btn btn-outline-secondary"
                          @click="addRelation(tableIndex)"
                          :disabled="relationOptionList(tableIndex)?.length === 0"
                        >
                          <span class="align-middle material-symbols-outlined">add</span>
                          Add Relation
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="dropdown float-end">
          <button
            class="btn btn-secondary dropdown-toggle"
            type="button"
            data-bs-toggle="dropdown"
            aria-expanded="false"
          >
            <span class="align-middle material-symbols-outlined">menu</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><button type="button" class="dropdown-item" @click="addTable">Add Table</button></li>
            <li><button type="button" class="dropdown-item" @click="save">Save</button></li>
            <li><button type="button" class="dropdown-item" @click="showImage">Show Image</button></li>
          </ul>
        </div>
      </div>
    </main>
  </div>

  <!--/* 追加コンテンツ */-->
  <th:block layout:fragment="additional-contents">
    <th:block th:replace="~{common/components :: offcanvas('bottom', 'PlantUML画像', ~{::div#previewImageContainer})}">
      <div id="previewImageContainer">
        <img v-if="imageSrc != ''" :src="imageSrc" />
      </div>
    </th:block>
  </th:block>

  <!--/* JS */-->
  <th:block layout:fragment="scripts">
    <script th:inline="javascript">
      const relationEdgeTypeEnumList = /*[[${relationEdgeTypeEnum}]]*/ null;
      const relationLineTypeEnumList = /*[[${relationLineTypeEnum}]]*/ null;
    </script>
    <script type="module" th:src="@{/js/er/index.js}"></script>
  </th:block>
</html>
